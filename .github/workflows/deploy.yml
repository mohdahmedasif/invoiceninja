name: Deploy to VPS

on:
  push:
    branches:
      - main          # Your fork's main branch
      - master        # Your fork's master branch (if you use it)
      - v5-stable     # Your fork's v5-stable branch (if you use it)
    # Uncomment the line below to enable manual deployment
    # workflow_dispatch:

env:
  # This will use the branch that triggered the workflow
  DEPLOY_BRANCH: ${{ github.ref_name }}

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS (Safe Mode - Protects .env & DB)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_APP_PATH: ${{ secrets.VPS_APP_PATH }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << ENDSSH
            set -e
            export DEPLOY_BRANCH="${{ env.DEPLOY_BRANCH }}"
            cd $VPS_APP_PATH
            
            # Run deployment script
            if [ -f deploy.sh ]; then
              chmod +x deploy.sh
              DEPLOY_BRANCH="${{ env.DEPLOY_BRANCH }}" bash deploy.sh
            else
              echo "âš ï¸  Deployment script not found. Running basic safe deployment..."
              
              # CRITICAL: Protect .env file
              if [ ! -f .env ]; then
                echo "âœ— ERROR: .env file not found! Cannot proceed."
                exit 1
              fi
              
              # Enable maintenance mode
              php artisan down --retry=60 || true
              
              # Ensure .env is not tracked by git
              git update-index --assume-unchanged .env 2>/dev/null || true
              
              # Stash .env if needed
              git stash push -m "protect_env_\$(date +%s)" .env 2>/dev/null || true
              
              # Git pull
              git fetch origin
              git reset --hard origin/${{ env.DEPLOY_BRANCH }}
              
              # Restore .env from stash
              git stash pop 2>/dev/null || true
              git update-index --assume-unchanged .env 2>/dev/null || true
              
              # Install dependencies
              composer clear-cache || true
              COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-req=ext-redis --prefer-dist || {
                echo "âš ï¸  Composer install failed, cleaning cache and retrying..."
                composer clear-cache
                COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-req=ext-redis --prefer-dist
              }
              
              # Run post-update commands (safe migrations)
              php artisan ninja:post-update
              
              # Clear and optimize
              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              
              # Final .env check
              if [ ! -f .env ]; then
                echo "âœ— ERROR: .env file missing after deployment!"
                git stash pop 2>/dev/null || true
              fi
              
              # Disable maintenance mode (with fallback if vendor is broken)
              php artisan up 2>/dev/null || {
                echo "âš ï¸  Could not disable via artisan, removing maintenance file directly..."
                rm -f storage/framework/down 2>/dev/null || true
                echo "âœ“ Maintenance mode disabled"
              }
              
              echo "âœ… Basic deployment completed (using fallback method)"
            fi
          ENDSSH

      - name: Deployment Status
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ”’ .env file is protected!"
